<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cita</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.js"></script>
</head>

<body>

    <div class="container mt-14 ">


        <h1 class="text text-center">Escoge tu cita para análisis</h1>

        <div class="row">
            <div class="col-12 d-flex justify-content-center mb-3">
                <div id="asegurado">
                   
                </div>

            </div>
        </div>

        <div class="row">
            <div class="col-12 d-flex justify-content-center ">

                <div id="citas" class="d-inline p-2">

                </div>

            </div>
        </div>
    </div>


    <script>

        comprobar_sesion();

        //llama al documento que registrta la cita y muestra alert con el resultado.
        function cancelar_cita(dia,horario){
            

            $.confirm({
                title: '¿quieres cancelar tu cita?',
                content: "",
                buttons: {
                    Si: function () {

                        $.post(
                            "cita.php",
                            {dia:dia, hora:horario, accion:"cancelar"},
                            function(echo){

                                    if(echo=="cancelada"){
                                        alert("Cita cancelada correctamente");
                                    }else if(echo =="no_usuario"){
                                        alert(" Primero debes introducir tu número de asegurado");
                                    }

                                    vercitas();
                            }
                        )
                    },
                    No: function () {
                        $.alert('No hemos cancelado la cita');
                        vercitas();
                    }}}
                
                )
           
             vercitas();
        }

        //llama al documento que registrta la cita y muestra alert con el resultado.
        function citar(dia,horario){
            
             $.post(
                "cita.php",
               {dia:dia, hora:horario, accion:"nueva"},
                function(echo){

                        if(echo=="registrada"){
                            alert("Cita registrada correctamente");
                        }else if(echo =="no_usuario"){
                            alert(" Primero debes introducir tu número de asegurado");
                        }
                        vercitas();
                }
             )

          
            }



        //Comprueba la sesión y según esto muestra un mensaje o un formulario
        function comprobar_sesion(){
            $.post(
                "usuario.php",
                {accion: "comprobar"},
                function (echosdelphp) {

                    if(echosdelphp==""){
                        formulario_usuario();
                    }else{
                        mostrar_asegurado(echosdelphp);
                    }

                     vercitas();


                                      
                })
        }


        //Solicita destruir la sesión y que se recarguen las citas
        function limpiar_usuario(){
            $.post(
                "usuario.php",
                { accion: "limpiar" },
                function () {
                    formulario_usuario();                   
                })

               vercitas();

            }
        

        //LLama al documento para crear el usuario en la sesión
        function asignar_usuario() {

            var asegurado = $("#usuario").val();

            $.post(
                "usuario.php",
                { asegurado: asegurado, accion: "asignar" },
                function () {

                    comprobar_sesion();
                }
            )
        }

        //HTML que muestra los datos del asegurado  
        function mostrar_asegurado(asegurado) {

            var boton = " <button class='btn btn-warning btn-sm ms-2 ' onclick='limpiar_usuario()'> Modificar</button>"

            $("#asegurado").html("Asegurado nº: " + asegurado + boton);

        }

        //Llama al documento para que compruebe y muestre el estado de las citas
        function vercitas() {

            $.post(
                "citas.php",
                {},
                function (echosdelphp) {
                    $("#citas").html(echosdelphp);
                    $("button#vercitas").prop("hidden", true);
                }
            );
        }


          //HTML que muestra el formulario para el asegurado
        function formulario_usuario(){

            var boton = "<button class='btn btn-success' onclick='asignar_usuario()'>Aceptar</button>";

            var html_asegurado=" <label class='form-label' for='usuario'> Introduce tu número de asegurado</label><input type='text' id='usuario' class='form-control' placeholder='Número de asegurado'> " + boton;

            $("#asegurado").html(html_asegurado);
        }


    </script>

</body>

</html>